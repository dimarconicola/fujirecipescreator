# Calibration Harness v1 (Bootstrap)

Date: 2026-02-19
Status: Bootstrap implementation (`NI-030` started)

## 1. Purpose

Provide a reproducible, manifest-driven calibration harness that:

1. renders deterministic CPU approximation outputs for scene/control sweeps
2. records or evaluates oracle artifacts
3. produces machine-readable metrics + markdown summary
4. applies threshold gates for CI-style evaluation

This is a bootstrap harness to operationalize `docs/engineering/calibration-oracle-protocol-v1.md`.

## 2. Entry Points

Root scripts:

1. `npm run calibration:record`
2. `npm run calibration:run`
3. `npm run calibration:dry-run`
4. `npm run calibration:baseline:lock`
5. `npm run calibration:baseline:refresh`
6. `npm run calibration:baseline:check`
7. `npm run calibration:oracle:index:check`
8. `npm run calibration:oracle:index:check:camera-engine`
9. `npm run calibration:camera:oracle:import`
10. `npm run calibration:camera:oracle:check`
11. `npm run calibration:camera:bootstrap`
12. `npm run calibration:camera:bootstrap:dry-run`
13. `npm run calibration:camera:run`
14. `npm run calibration:camera:baseline:check`
15. `npm run calibration:camera:baseline:lock`
16. `npm run calibration:camera:baseline:refresh`
17. `npm run calibration:camera:gate:validate`
18. `npm run calibration:camera:gate:validate:strict`
19. `npm run calibration:camera:gate:strict`
20. `npm run calibration:camera:gate`
21. `npm run calibration:tune:report`
22. `npm run calibration:camera:tune:report`

Implementation:

1. `scripts/run-calibration-harness.mjs`
2. `calibration/manifest.v1.json`
3. `calibration/thresholds.v1.json`
4. `artifacts/calibration/oracle-v1/index.v1.json` (generated in `record` mode)
5. `scripts/import-camera-oracle.mjs`
6. `scripts/bootstrap-camera-calibration-assets.mjs`
7. `artifacts/calibration/oracle-camera-engine-v1/index.v1.json` (generated by camera import script)
8. `scripts/report-calibration-tuning.mjs`

## 3. Modes

1. `record`
 - renders all manifest scene/case combinations
 - writes oracle JPEGs to `artifacts/calibration/oracle-v1`
 - writes oracle index contract to `artifacts/calibration/oracle-v1/index.v1.json` (scene/case -> file/hash/source)
 - writes run artifacts under `artifacts/calibration/runs/<timestamp>`

2. `evaluate`
 - renders manifest scene/case combinations
 - compares against existing oracle JPEGs
 - if oracle index exists, validates scene/case coverage and hash integrity
 - supports oracle source policy enforcement:
   - `npm run calibration:run -- --require-oracle-source camera_engine`
   - fails when index/source entries are not camera-engine tagged (`camera_engine*`)
 - writes metrics + summary artifacts under `artifacts/calibration/runs/<timestamp>`
 - exits non-zero when thresholds fail or oracle files are missing
 - optional regression compare:
   - `npm run calibration:run -- --baseline-metrics <path/to/metrics.json>`
   - fails when aggregate error metrics drift above `calibration/thresholds.v1.json` regression limits
   - fails when directional axis score drops beyond configured tolerance

3. `dry-run`
 - executes `record` then `evaluate`
 - intended as CI smoke coverage for harness reproducibility and threshold-check execution path

4. `baseline:check`
 - runs `evaluate` against locked baseline `calibration/baseline/metrics.v1.json`
 - intended for manual/local release-candidate validation before promoting CI gate strictness

5. `baseline:refresh`
 - executes `dry-run` and then locks latest run as baseline
 - intended for controlled baseline updates when rendering changes are intentionally accepted

6. `oracle:index:check`
 - validates `artifacts/calibration/oracle-v1/index.v1.json` against current manifest scene/case matrix
 - verifies hash integrity and file-path containment in oracle directory
 - optional strict source policy:
   - `npm run calibration:oracle:index:check:camera-engine`
   - fails when index/global source is not camera-engine tagged

7. `camera:oracle:import`
 - imports camera-engine exported JPEGs into strict oracle directory/index:
   - source dir default: `artifacts/calibration/camera-engine-exports`
   - target dir default: `artifacts/calibration/oracle-camera-engine-v1`
 - expects manifest pair filenames:
   - `<scene_id>__<case_id>.jpg` (also accepts `.jpeg` variants)
 - emits strict camera-source index (`source_type` must start with `camera_engine`)

8. `camera:oracle:check`
 - validates strict camera oracle index under `artifacts/calibration/oracle-camera-engine-v1/index.v1.json`
 - enforces `camera_engine*` source policy for index and entries

9. `camera:run`
 - executes evaluate harness against strict camera oracle directory/index
 - enforces `--require-oracle-source camera_engine`

10. `camera:bootstrap`
 - sources missing manifest scene files from approved metadata URLs (Wikimedia/Pexels) when needed
 - runs calibration `record` flow to generate scene/case output set
 - imports generated set into strict camera-oracle index with `camera_engine_bootstrap_seed` source type
 - optionally locks camera baseline and validates gate preflight in one command
 - explicit disclosure: bootstrap output is an educational seed dataset, not first-party camera-engine parity output

11. `camera:baseline:check`
 - runs strict camera evaluate against `calibration/baseline/metrics.camera_engine.v1.json`
 - intended as camera-oracle release-candidate check when camera baseline is present

12. `camera:baseline:lock`
 - locks latest run to camera baseline path:
   - `calibration/baseline/metrics.camera_engine.v1.json`
   - `calibration/baseline/metadata.camera_engine.v1.json`
 - source selection is policy-filtered (`--require-oracle-source camera_engine`) to avoid locking non-camera runs

13. `camera:gate`
 - requires camera oracle index + camera baseline metrics to exist
 - requires camera baseline metadata (`calibration/baseline/metadata.camera_engine.v1.json`) to exist and match the expected baseline metrics path/policy
 - executes strict camera-source index check and strict camera baseline check in one command
 - optional strict source hygiene gate:
   - `npm run calibration:camera:gate -- --disallow-bootstrap-source`
   - fails when index or entry source tags include `bootstrap`
 - supports validation-only mode for CI/ops preflight:
   - `npm run calibration:camera:gate -- --validate-only`
 - supports skipping engine rebuild when build already ran earlier in pipeline:
   - `npm run calibration:camera:gate -- --skip-build`
 - supports explicit path overrides for custom artifact locations:
   - `--oracle-index <path>`
   - `--baseline-metrics <path>`
   - `--baseline-metadata <path>`
 - CI behavior:
   - conditional mode: runs when camera artifacts exist
   - required mode: set repository variable `CAMERA_CALIBRATION_REQUIRED=true`
   - strict source mode: set repository variable `CAMERA_CALIBRATION_DISALLOW_BOOTSTRAP=true`
   - tuning-signal mode: set repository variable `CAMERA_TUNING_SIGNAL_REQUIRED=true` (runs `calibration:camera:tune:report` and fails low-signal bootstrap runs)

14. `tune:report`
 - analyzes latest calibration metrics (or explicit `--metrics`) and writes `tuning-report.md`
 - reports per-axis directional deltas and concrete tuning actions (`increase`, `decrease`, `reverse`, `review`, `aligned`)
 - detects low-signal runs (for example bootstrap + zero-delta) and emits explicit block reasons
 - optional strict low-signal gate:
   - `npm run calibration:camera:tune:report`
   - equivalent to `npm run calibration:tune:report -- --require-oracle-source camera_engine --fail-on-low-signal`

## 4. Metrics (Current Bootstrap Set)

Per frame:

1. `mean_delta_e00`
2. `p95_delta_e00`
3. `luma_rmse`
4. `mean_chroma_error`
5. `mean_hue_drift_deg`
6. `mean_delta_e76` (legacy diagnostic)
7. `p95_delta_e76` (legacy diagnostic)
8. `mean_abs_rgb` (diagnostic)

Directional:

1. luma-direction correctness against baseline case for each axis
2. axis score by class (`critical`/`secondary`) using threshold config

## 5. Artifacts

Per run:

1. `metrics.json` (full machine-readable output)
2. `summary.md` (human-readable table summary)
3. `rendered/*.jpg` (candidate renders for trace/debug)
4. `diff/*.jpg` (candidate-vs-oracle false-color difference maps)

Baseline lock artifacts:

1. `calibration/baseline/metrics.v1.json`
2. `calibration/baseline/metadata.v1.json`

## 6. Known Gaps (Planned Follow-up)

1. Default calibration path remains bootstrap CPU-based; strict camera path is opt-in until camera oracle assets are available in repo/CI.
2. CI runs strict camera checks conditionally unless `CAMERA_CALIBRATION_REQUIRED=true` is set.
3. `--disallow-bootstrap-source` should be enabled only when true camera-engine export datasets replace bootstrap-seeded oracle entries.
4. Tuning report recommendations are luma/directional first-pass heuristics; they should be validated with strict camera baseline checks before locking constants.
